# This job loads a target (SqlServer) database with each of the specified tables in each of the specified source (MySQL) databases

# We iterate over each specified tableName that we wish to import
type: "iterating-job"
description: "Load upper and lower neno reporting tables to SQL Server"
configuration:
  maxConcurrentJobs: 1 # Tweak this setting to import more or fewer tables concurrently, to hone performance
  jobTemplate: # For each iteration, we execute a pipeline to import data into a given table
    type: "job-pipeline"
    description: "Load ${tableName}"
    configuration:
      maxConcurrentJobs: 1 # This needs to be 1, because we need this to run as a serial pipeline (create table before loading table)
      jobs:
        # First step is we drop and recreate the schema
        - type: "create-table"
          description: "Drop and create table: ${tableName} in SQL Server"
          configuration:
            source:
              datasource: "upperNenoReporting.yml" # We assume that the two source databases have the same schema, and choose one here
              tableName: "${tableName}"
            target:
              datasource: "consolidatedReporting.yml"
              tableName: "${tableName}"
              actionIfExists: "drop"
        # Next step is we iterate over sources and import from each
        - type: "iterating-job"
          description: "Iterating job over upper and lower neno reporting to load ${tableName} in SQL Server"
          configuration:
            maxConcurrentJobs: 2 # To run the Upper and Lower Neno imports at the same time, use 2.  Otherwise, use 1.
            iterations:
              - extractDatasource: "upperNenoReporting.yml"
              - extractDatasource: "lowerNenoReporting.yml"
            jobTemplate:
              type: "sqlserver-bulk-import"
              description: "Load ${tableName} in SQL Server from ${extractDatasource}"
              configuration:
                extract:
                  datasource: "${extractDatasource}"
                  query: "selectAllFromTable.sql"
                load:
                  datasource: "consolidatedReporting.yml"
                  table: "${tableName}"
  # For any new table created in the Pentaho pipeline that we want to exist in SQL Server, it needs to be added as an "iteration" below
  iterations:
    - tableName: "mw_art_followup"
    - tableName: "mw_art_initial"
    - tablename: "mw_art_followup_testing"
    - tableName: "mw_art_regimen"
    - tableName: "mw_art_register"
    - tableName: "mw_art_viral_load"
    - tableName: "mw_art_visits"
    - tableName: "mw_asthma_followup"
    - tableName: "mw_asthma_initial"
    - tableName: "mw_chf_followup"
    - tableName: "mw_chf_initial"
    - tableName: "mw_ckd_followup"
    - tableName: "mw_ckd_initial"
    - tableName: "mw_diabetes_hypertension_followup"
    - tableName: "mw_diabetes_hypertension_initial"
    - tableName: "mw_diabetes_hypertension_annual_lab_tests"
    - tableName: "mw_eid_followup"
    - tableName: "mw_eid_initial"
    - tableName: "mw_eid_register"
    - tableName: "mw_eid_visits"
    - tableName: "mw_eid_lab_tests"
    - tableName: "mw_epilepsy_followup"
    - tableName: "mw_epilepsy_initial"
    - tableName: "mw_lab_tests"
    - tableName: "mw_lab_tests_recent_period"
    - tableName: "mw_last_obs_in_period"
    - tableName: "mw_mental_health_followup"
    - tableName: "mw_mental_health_initial"
    - tableName: "mw_ncd_diagnoses"
    - tableName: "mw_ncd_other_followup"
    - tableName: "mw_ncd_other_initial"
    - tableName: "mw_ncd_register"
    - tableName: "mw_ncd_visits"
    - tableName: "mw_nutrition_adult_initial"
    - tableName: "mw_nutrition_adult_followup"
    - tableName: "mw_nutrition_teen_initial"
    - tableName: "mw_patient"
    - tableName: "mw_pre_art_register"
    - tableName: "mw_pre_art_visits"
    - tableName: "mw_pdc_initial"
    - tableName: "mw_pdc_trisomy_21_followup"
    - tableName: "mw_pdc_developmental_delay_followup"
    - tableName: "mw_pdc_other_diagnosis_followup"
    - tableName: "mw_pdc_history_of_hospitalization"
    - tableName: "mw_pdc_cleft_lip_palate_followup"
    - tableName: "mw_pdc_diagnoses"
    - tableName: "mw_pdc_vision_test"
    - tableName: "mw_pdc_radiology"
    - tableName: "mw_pdc_complications"
    - tableName: "mw_pdc_hearing_test"
    - tableName: "mw_pdc_visits"
    - tableName: "omrs_encounter"
    - tableName: "omrs_encounter_provider"
    - tableName: "omrs_obs"
    - tableName: "omrs_obs_group"
    - tableName: "omrs_patient"
    - tableName: "omrs_patient_identifier"
    - tableName: "omrs_program_enrollment"
    - tableName: "omrs_program_state"
    - tableName: "omrs_relationship"
    - tableName: "omrs_visit"
